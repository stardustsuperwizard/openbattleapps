{% extends 'base.html' %}
{% block content %}
    <div>
        <a href="{{ url_for('index') }}">Back</a>
    </div>
    <div 
    x-data="main()"
    x-init="units = await idb.readTable('Units')">
        <form action="">
            <div>
                <div>
                    <label for="unitName">Unit name:</label><br>
                    <input type="text" name="unitName" id="unitName" x-model="unitName">
                </div>

                <div>
                    <label for="unitRangedCombatValue">Ranged Combat:</label><br>
                    <input type="number" min="0" max="5" name="unitRangedCombatValue" id="unitRangedCombatValue" x-model="rcvalue">
                    <input type="number" name="unitRangedCombatCost" id="unitRangedCombatCost" x-bind:value="pointcostRC" disabled><br>
                </div>

                <div>
                    <label for="unitCloseCombatValue">Close Combat:</label><br>
                    <input type="number" min="0" max="5" name="unitCloseCombatValue" id="unitCloseCombatValue" x-model="ccvalue">
                    <input type="number" name="unitCloseCombatCost" id="unitCloseCombatCost" x-bind:value="pointcostCC" disabled><br>
                </div>

                <div>
                    <label for="unitToughnessValue">Toughness:</label><br>
                    <input type="number" min="2" name="unitToughnessValue" id="unitToughnessValue" x-model="tvalue">
                    <input type="number" name="unitToughnessCost" id="unitToughnessCost" x-bind:value="pointcostTough" disabled><br>
                </div>

                <div>
                    <label for="unitHitPointsValue">Hit Points:</label><br>
                    <input type="number" min="1" value="1" name="unitHitPointsValue" id="unitHitPointsValue" x-model="hpvalue">
                    <input type="number" name="unitHitPointsCost" id="unitHitPointsCost" x-bind:value="pointcostHP" disabled><br>
                </div>

                <div>
                    <label for="unitCombatSaveValue">Combat Save:</label><br>
                    <input type="number" min="0" max="5" name="unitCombatSaveValue" id="unitCombatSaveValue" x-model="csvalue">
                    <input type="number" name="unitCombatSaveCost" id="unitCombatSaveCost" x-bind:value="pointcostCS" disabled><br>
                </div>

                <div>
                    <label for="unitMovementValue">Movement:</label><br>
                    <input type="number" min="0" name="unitMovementValue" id="unitMovementVealue" x-model="movement">
                    <input type="number" name="unitMovementost" id="unitMovementCost" x-bind:value="pointcostMove" disabled><br>
                </div>

                <div>
                    <label for="unitTotalCost">Total Cost:</label><br>
                    <input type="number" name="unitTotalCost" id="unitTotalCost" x-bind:value="totalCost" disabled>
                </div>
            </div>
            <input type="Button" value="Save" x-on:click.prevent="addBattleUnit">
            <input type="Button" value="Clear" x-on:click.prevent="resetForm">
        </form>
        <div>
            <table x-init="getBattleUnits()">
                <tr>
                    <td>Id</td>
                    <td>Unit Name</td>
                    <td>RC</td>
                    <td>CC</td>
                    <td>T</td>
                    <td>HP</td>
                    <td>CS</td>
                    <td>M</td>
                    <td>Point Cost</td>
                </tr>
                <template x-for="(unit, index) in units">
                    <tr>
                        <td x-text="unit.id"></td>
                        <td x-text="unit.unitName"></td>
                        <td x-text="unit.rangedCombatValue"></td>
                        <td x-text="unit.closeCombatValue"></td>
                        <td x-text="unit.toughnessValue"></td>
                        <td x-text="unit.hitPointsValue"></td>
                        <td x-text="unit.combatSaveValue"></td>
                        <td x-text="unit.movementValue"></td>
                        <td x-text="unit.totalPointCost"></td>
                        <td><button x-on:click="editBattleUnit(unit.id)">Edit</button></td>
                        <td><button x-on:click="deleteBattleUnit(unit.id)">Delete</button></td>
                    </tr>
                </template>
            </table>
        </div>
    </div>

    {% block javascript %}
    <script>
    function main() {
        return { 
            unitId: null,
            unitName: '',
            rcvalue: 0,
            ccvalue: 0,
            tvalue: 2,
            hpvalue: 1,
            csvalue: 0,
            movement: 0,

            units: [],
            
            get pointcostRC() { return Math.pow(1.50, this.rcvalue) - 1 },
            get pointcostCC() {return Math.pow(1.75, this.ccvalue) - 1 },
            get pointcostTough() {return Math.pow(1.15, this.tvalue) },
            get pointcostHP() {return Math.pow(1.15, this.hpvalue) * this.hpvalue },
            get pointcostCS() {return this.csvalue * 1.75 },
            get pointcostMove() {return Math.pow(1.20, this.movement) - 1 },
            get totalCost() { return ( this.pointcostRC + this.pointcostCC + this.pointcostTough + this.pointcostHP + this.pointcostCS + this.pointcostMove ) * this.hpvalue },


            async getBattleUnits() {
                this.units = await idb.readTable('Units');
                // console.log(this.units);
            },
            addBattleUnit() {
                // console.log('hello')
                let tempUnit;
                if (this.unitId != null) {
                    tempUnit = {
                        id: this.unitId,
                        unitName: this.unitName,
                        rangedCombatValue: this.rcvalue,
                        closeCombatValue: this.ccvalue,
                        toughnessValue: this.tvalue,
                        hitPointsValue: this.hpvalue,
                        combatSaveValue: this.csvalue,
                        movementValue: this.movement,
                        totalPointCost: this.totalCost,
                    }
                } else {
                    tempUnit = {
                        unitName: this.unitName,
                        rangedCombatValue: this.rcvalue,
                        closeCombatValue: this.ccvalue,
                        toughnessValue: this.tvalue,
                        hitPointsValue: this.hpvalue,
                        combatSaveValue: this.csvalue,
                        movementValue: this.movement,
                        totalPointCost: this.totalCost,
                    }
                }
                // console.log(tempGear); 
                // console.log(this.squadId);
                idb.createEntry('Units', tempUnit)
                    .then((resp) => {
                        // console.log(resp);
                        // this.gearId = resp.result;
                        this.resetForm();
                        this.getBattleUnits();
                    });
                // console.log(this.squadId);
            },
            editBattleUnit(unitId) {
                // console.log(gearId);    
                idb.readTableEntry('Units', unitId)
                    .then((resp) => {
                        // console.log(resp);
                        this.unitId = resp.id,
                        this.unitName = resp.unitName;
                        this.rcvalue = resp.rangedCombatValue;
                        this.ccvalue = resp.closeCombatValue;
                        this.tvalue = resp.toughnessValue;
                        this.hpvalue = resp.hitPointsValue;
                        this.csvalue = resp.combatSaveValue;
                        this.movement = resp.movementValue;
                    });
            },
            deleteBattleUnit(unitId) {
                // console.log(gearId);
                idb.deleteEntry('Units', unitId)
                    .then((resp) => {
                        this.getBattleUnits();
                    });
            },
            resetForm() {
                this.unitId = null,
                this.unitName = '';
                this.rcvalue = 0;
                this.ccvalue = 0;
                this.tvalue = 2;
                this.hpvalue = 1;
                this.csvalue = 0;
                this.movement = 0;
            },
        }
    }
    </script>
    {% endblock %}
{% endblock %}