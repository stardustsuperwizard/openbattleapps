<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Battle System</title>
    <script defer src="alpine.js"></script>
    <script src="EasyIDB.js"></script>
</head>
<body>
    <div 
    x-data="{ 
        gearName: '',
        saveModifier: 0,
        strength: 0,
        attacks: 1,
        distance: 0,

        units: [],

        get saveModifierCost() { return Math.pow(1.25, this.saveModifier) - 1 },
        get strengthCost() { return Math.pow(1.11, this.strength) * this.strength },
        get attacksCost() { return ( Math.pow(1.5, this.attacks) - 1 ) },
        get distanceCost() { return ((this.distance * 6) * 0.25) / 6 },
        get totalCost() { return ( this.distanceCost + this.attacksCost + this.strengthCost + this.saveModifierCost ) },

        async addToGear() { 
            let gear = {
                'gearName': this.gearName,
                'DST': this.distance,
                'A': this.attacks,
                'S': this.strength,
                'SM': this.saveModifier,
                'PointCost': this.totalCost
            }
            gear.id = await addEntry(gear);
            this.units.push(gear); 
            this.resetForm();
        },

        resetForm() {
            this.gearName = '';
            this.distance = 0;
            this.attacks = 1;
            this.strength = 2;
            this.saveModifier = 1;
        },

        loadGear(index) {
            this.gearName = this.units[index].gearName;
            this.distance = this.units[index].DST;
            this.attacks = this.units[index].A;
            this.stength = this.units[index].S;
            this.saveModifier = this.units[index].SM;
        },

        deleteGear(index, id) {
            idb.deleteEntry('Gear', id);
            this.units.splice(index, 1);
        }
    }"
    x-init="units = await idb.readTable('Gear')">
        <form action="">
            <div>
                <div>
                    <label for="gearName">Gear name:</label><br>
                    <input type="text" name="gearName" id="gearName" x-model="gearName">
                </div>

                <div>
                    <label for="gearDistanceValue">Distance:</label><br>
                    <input type="number" min="0" name="gearDistanceValue" id="gearDistanceValue" x-model="distance">
                    <input type="number" name="gearDistanceCost" id="gearDistanceCost" x-bind:value="distanceCost" disabled><br>
                </div>

                <div>
                    <label for="gearAttackValue">Attacks:</label><br>
                    <input type="number" min="0" name="gearAttackValue" id="gearAttackValue" x-model="attacks">
                    <input type="number" name="gearAttackCost" id="gearAttackCost" x-bind:value="attacksCost" disabled><br>
                </div>

                <div>
                    <label for="gearStrengthValue">Strength:</label><br>
                    <input type="number" min="0" name="gearStrengthValue" id="gearStrengthValue" x-model="strength">
                    <input type="number" name="gearStrengthCost" id="gearStrengthCost" x-bind:value="strengthCost" disabled><br>
                </div>

                <div>
                    <label for="gearSaveModifierValue">Save Modifier:</label><br>
                    <input type="number" min="0" max="5" name="gearSaveModifierValue" id="gearSaveModifierValue" x-model="saveModifier">
                    <input type="number" name="gearSaveModifierCost" id="gearSaveModifierCost" x-bind:value="saveModifierCost" disabled><br>
                </div>

                <div>
                    <label for="gearTotalCost">Total Cost:</label><br>
                    <input type="number" name="gearTotalCost" id="gearTotalCost" x-bind:value="totalCost" disabled>
                </div>
            </div>
            <input type="Button" value="Add" x-on:click.prevent="addToGear">
            <input type="Button" value="Clear" x-on:click.prevent="resetForm">
        </form>
        <div>
            <table x-ref="myTable">
                <tr>
                    <td></td>
                    <td>Gear Name</td>
                    <td>DST</td>
                    <td>A</td>
                    <td>S</td>
                    <td>SM</td>
                    <td>Point Cost</td>
                </tr>
                <template x-for="(gear, index) in units">
                    <tr>
                        <td><button x-on:click="loadGear(index)" x-text="index"></button></td>
                        <template x-for="value in gear">
                            <td x-text="value"></td>
                        </template>
                        <td><button x-on:click="deleteGear(index, gear.id)" x-text="index">Delete</button></td>
                    </tr>
                </template>
            </table>
        </div>
    </div>

    <script>
tables = [
    {
        'name': 'Gear',
        'options': {
            autoIncrement: true,
            keyPath: 'id'
        },
        'index': [
            {
                indexName: 'gearName',
                keyPath: 'gearName',
                objectParameters: {
                    unique: false
                }
            },
            {
                indexName: 'distance',
                keyPath: 'distance',
                objectParameters: {
                    unique: false
                }
            },
            {
                indexName: 'attacks',
                keyPath: 'attacks',
                objectParameters: {
                    unique: false
                }
            },
            {
                indexName: 'strength',
                keyPath: 'strength',
                objectParameters: {
                    unique: false
                }
            },
            {
                indexName: 'saveModifier',
                keyPath: 'saveModifier',
                objectParameters: {
                    unique: false
                }
            },
            {
                indexName: 'totalPointCost',
                keyPath: 'totalPointCost',
                objectParameters: {
                    unique: false
                }
            },
        ]
    }
]
const idb = new EasyIDB('mainDB', tables, 2);
idb.getDB();

async function addEntry(unit) {
    let result = await idb.createEntry('Gear', {
        gearName: unit.unitName,
        distance: unit.DST,
        attacks: unit.A,
        strength: unit.S,
        saveModifier: unit.SM,
        totalPointCost: unit.PointCost,
    }).then(function(request) { return request.result });
    return result;
}
    </script>
</body>
</html>